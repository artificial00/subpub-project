# Проект SubPub

## Описание

Проект реализует систему публикации и подписки (Pub/Sub), которая состоит из двух основных компонентов:

1. **Шина событий (subpub)**
2. **gRPC сервис для подписки и публикации событий**

---

## 1. Шина событий (subpub)

Шина событий реализует паттерн **Publisher-Subscriber (Pub/Sub)**. Основные характеристики реализации:

- **Множественные подписчики на один subject**  
  Каждый subject поддерживает подписку нескольких подписчиков. Все они получают события, опубликованные по этому ключу.

- **Подписка и отписка**  
  Подписчики могут подписываться и отписываться в любой момент, не влияя на других.

- **Сохранение порядка сообщений (FIFO)**  
  Каждое сообщение доставляется подписчикам в порядке его публикации.

- **Изоляция подписчиков**  
  Один медленный подписчик не блокирует остальных. Сообщения доставляются каждому подписчику независимо.

- **Graceful Shutdown с учетом контекста**  
  Метод `Close` корректно завершает работу шины. Если переданный контекст отменен, метод немедленно завершает работу, оставляя действующие обработчики дообрабатывать свои сообщения.

- **Без утечек горутин**  
  Все горутины завершаются корректно. Никакие ресурсы не висят в фоне после закрытия системы.

### Юнит-тесты
#### Покрыты следующие сценарии:
- **базовая публикация и подписка**

- **множественные подписчики**

- **проверка отписки**

- **сохранение порядка сообщений (FIFO)**

- **поведение при медленном подписчике**

- **корректное завершение по Close с context**


---

## 2. gRPC сервис

Позволяет клиентам:

- Подписываться на события по ключу
- Публиковать события

### Протокол

Используется **Protocol Buffers**. Основные сущности:

- `SubscribeRequest` — запрос на подписку (ключ subject)
- `PublishRequest` — запрос на публикацию события
- `Event` — событие, передаваемое подписчикам

### Методы gRPC API

- `rpc Subscribe(SubscribeRequest) returns (stream Event)`
- `rpc Publish(PublishRequest) returns (PublishResponse)`

### Graceful Shutdown
**Сервер корректно обрабатывает сигналы SIGINT и SIGTERM. При завершении:**

1. Контекст с таймаутом передаётся в SubPub.Close(ctx)

2. Ожидается завершение всех активных горутин подписчиков (если context не отменён)

3. Вызывается grpcServer.GracefulStop(), чтобы остановить gRPC корректно

---

## Сборка проекта

**Чтобы развернуть решение, нужно:**

**Сначала склонируйте репозиторий с помощью команды**

``` git clone https://github.com/artificial00/subpub-project.git ```

**Затем, в корне проекта создайте файл .env и укажите необходимый порт, например:**

```GRPC_PORT=5050```

**Для запуска юнит-тестов есть два варианта**

1. если работаете через IDE GoLand, можно перейти в файл subpub_test.go и запустить каждый тест отдельно через зеленую кнопку run рядом с названием теста
2. или прописать в терминале для запуска всех тестов

``` go test ./pkg/subpub -v ```

**Чтобы запустить сервис**

```go run ./cmd/app```


